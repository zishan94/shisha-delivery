{"version":3,"sources":["../../../src/utils/net.ts"],"sourcesContent":["import type { IncomingHttpHeaders } from 'node:http';\nimport type { Socket } from 'node:net';\n\nconst ipv6To4Prefix = '::ffff:';\n\nexport const isLocalSocket = (socket: Socket): boolean => {\n  let { localAddress, remoteAddress, remoteFamily } = socket;\n\n  const isLoopbackRequest = localAddress && localAddress === remoteAddress;\n  if (isLoopbackRequest) {\n    return true;\n  } else if (!remoteAddress || !remoteFamily) {\n    return false;\n  }\n\n  if (remoteFamily === 'IPv6' && remoteAddress.startsWith(ipv6To4Prefix)) {\n    remoteAddress = remoteAddress.slice(ipv6To4Prefix.length);\n  }\n\n  return remoteAddress === '::1' || remoteAddress.startsWith('127.');\n};\n\ninterface AbstractIncomingMessage {\n  headers: IncomingHttpHeaders | Record<string, string | string[]>;\n}\n\nexport const isMatchingOrigin = (\n  request: AbstractIncomingMessage,\n  serverBaseUrl: string\n): boolean => {\n  // NOTE(@kitten): The browser will always send an origin header for websocket upgrade connections\n  if (!request.headers.origin) {\n    return true;\n  }\n  const actualHost = new URL(`${request.headers.origin}`).host;\n  const expectedHost = new URL(serverBaseUrl).host;\n  return actualHost === expectedHost;\n};\n"],"names":["isLocalSocket","isMatchingOrigin","ipv6To4Prefix","socket","localAddress","remoteAddress","remoteFamily","isLoopbackRequest","startsWith","slice","length","request","serverBaseUrl","headers","origin","actualHost","URL","host","expectedHost"],"mappings":"AAAA;;;;;;;;;;;IAKaA,aAAa,MAAbA,aAAa;IAqBbC,gBAAgB,MAAhBA,gBAAgB;;AAvB7B,MAAMC,aAAa,GAAG,SAAS,AAAC;AAEzB,MAAMF,aAAa,GAAG,CAACG,MAAc,GAAc;IACxD,IAAI,EAAEC,YAAY,CAAA,EAAEC,aAAa,CAAA,EAAEC,YAAY,CAAA,EAAE,GAAGH,MAAM,AAAC;IAE3D,MAAMI,iBAAiB,GAAGH,YAAY,IAAIA,YAAY,KAAKC,aAAa,AAAC;IACzE,IAAIE,iBAAiB,EAAE;QACrB,OAAO,IAAI,CAAC;IACd,OAAO,IAAI,CAACF,aAAa,IAAI,CAACC,YAAY,EAAE;QAC1C,OAAO,KAAK,CAAC;IACf,CAAC;IAED,IAAIA,YAAY,KAAK,MAAM,IAAID,aAAa,CAACG,UAAU,CAACN,aAAa,CAAC,EAAE;QACtEG,aAAa,GAAGA,aAAa,CAACI,KAAK,CAACP,aAAa,CAACQ,MAAM,CAAC,CAAC;IAC5D,CAAC;IAED,OAAOL,aAAa,KAAK,KAAK,IAAIA,aAAa,CAACG,UAAU,CAAC,MAAM,CAAC,CAAC;AACrE,CAAC,AAAC;AAMK,MAAMP,gBAAgB,GAAG,CAC9BU,OAAgC,EAChCC,aAAqB,GACT;IACZ,iGAAiG;IACjG,IAAI,CAACD,OAAO,CAACE,OAAO,CAACC,MAAM,EAAE;QAC3B,OAAO,IAAI,CAAC;IACd,CAAC;IACD,MAAMC,UAAU,GAAG,IAAIC,GAAG,CAAC,CAAC,EAAEL,OAAO,CAACE,OAAO,CAACC,MAAM,CAAC,CAAC,CAAC,CAACG,IAAI,AAAC;IAC7D,MAAMC,YAAY,GAAG,IAAIF,GAAG,CAACJ,aAAa,CAAC,CAACK,IAAI,AAAC;IACjD,OAAOF,UAAU,KAAKG,YAAY,CAAC;AACrC,CAAC,AAAC"}