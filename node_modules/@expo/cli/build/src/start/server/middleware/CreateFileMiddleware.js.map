{"version":3,"sources":["../../../../../src/start/server/middleware/CreateFileMiddleware.ts"],"sourcesContent":["/**\n * Copyright Â© 2022 650 Industries.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\nimport fs from 'fs';\nimport path from 'path';\n\nimport { ExpoMiddleware } from './ExpoMiddleware';\nimport { ServerRequest, ServerResponse } from './server.types';\n\nconst debug = require('debug')('expo:start:server:middleware:createFile') as typeof console.log;\n\ninterface TouchFileInput {\n  type: 'router_index';\n}\n\ninterface TouchFileOutput {\n  absolutePath: string;\n  contents: string;\n}\n\nconst ROUTER_INDEX_CONTENTS = `import { StyleSheet, Text, View } from \"react-native\";\n\nexport default function Page() {\n  return (\n    <View style={styles.container}>\n      <View style={styles.main}>\n        <Text style={styles.title}>Hello World</Text>\n        <Text style={styles.subtitle}>This is the first page of your app.</Text>\n      </View>\n    </View>\n  );\n}\n\nconst styles = StyleSheet.create({\n  container: {\n    flex: 1,\n    alignItems: \"center\",\n    padding: 24,\n  },\n  main: {\n    flex: 1,\n    justifyContent: \"center\",\n    maxWidth: 960,\n    marginHorizontal: \"auto\",\n  },\n  title: {\n    fontSize: 64,\n    fontWeight: \"bold\",\n  },\n  subtitle: {\n    fontSize: 36,\n    color: \"#38434D\",\n  },\n});\n`;\n\ninterface CreateFileMiddlewareOptions {\n  /** The absolute metro or server root, used to calculate the relative dom entry path */\n  metroRoot: string;\n  /** The absolute project root, used to resolve the `expo/dom/entry.js` path */\n  projectRoot: string;\n  /** The expo-router root */\n  appDir: string;\n}\n\n/**\n * Middleware for creating a file given a `POST` request with\n * `{ contents: string, path: string }` in the body.\n */\nexport class CreateFileMiddleware extends ExpoMiddleware {\n  constructor(protected options: CreateFileMiddlewareOptions) {\n    super(options.projectRoot, ['/_expo/touch']);\n  }\n\n  protected resolveExtension(basePath: string, relativePath: string): string {\n    let resolvedPath = relativePath;\n    const extension = path.extname(relativePath);\n    if (extension === '.js') {\n      // Automatically convert JS files to TS files when added to a project\n      // with TypeScript.\n      const tsconfigPath = path.join(this.projectRoot, 'tsconfig.json');\n      if (fs.existsSync(tsconfigPath)) {\n        resolvedPath = resolvedPath.replace(/\\.js$/, '.tsx');\n      }\n    }\n    return path.join(basePath, resolvedPath);\n  }\n\n  protected async parseRawBody(req: ServerRequest): Promise<TouchFileInput> {\n    const rawBody = await new Promise<string>((resolve, reject) => {\n      let body = '';\n      req.on('data', (chunk) => {\n        body += chunk.toString();\n      });\n      req.on('end', () => {\n        resolve(body);\n      });\n      req.on('error', (err) => {\n        reject(err);\n      });\n    });\n\n    const body = JSON.parse(rawBody);\n    if (typeof body !== 'object' || body == null) {\n      throw new Error('Expected object');\n    } else if (typeof body.type !== 'string') {\n      throw new Error('Expected \"type\" in body to be string');\n    }\n\n    switch (body.type) {\n      case 'router_index':\n        return body;\n      default:\n        throw new Error('Unknown \"type\" passed in body');\n    }\n  }\n\n  private makeOutputForInput(input: TouchFileInput): TouchFileOutput {\n    switch (input.type) {\n      case 'router_index':\n        return {\n          absolutePath: this.resolveExtension(this.options.appDir, 'index.js'),\n          contents: ROUTER_INDEX_CONTENTS,\n        };\n    }\n  }\n\n  async handleRequestAsync(req: ServerRequest, res: ServerResponse): Promise<void> {\n    if (req.method !== 'POST') {\n      res.statusCode = 405;\n      res.end('Method Not Allowed');\n      return;\n    }\n\n    let properties: TouchFileInput;\n    try {\n      properties = await this.parseRawBody(req);\n    } catch (e) {\n      debug('Error parsing request body', e);\n      res.statusCode = 400;\n      res.end('Bad Request');\n      return;\n    }\n\n    debug(`Requested: %O`, properties);\n\n    const file = this.makeOutputForInput(properties);\n    if (fs.existsSync(file.absolutePath)) {\n      res.statusCode = 409;\n      res.end('File already exists.');\n      return;\n    }\n\n    debug(`Resolved path:`, file.absolutePath);\n\n    try {\n      await fs.promises.mkdir(path.dirname(file.absolutePath), { recursive: true });\n      await fs.promises.writeFile(file.absolutePath, file.contents, 'utf8');\n    } catch (e) {\n      debug('Error writing file', e);\n      res.statusCode = 500;\n      res.end('Error writing file.');\n      return;\n    }\n\n    debug(`File created`);\n    res.statusCode = 200;\n    res.end('OK');\n  }\n}\n"],"names":["CreateFileMiddleware","debug","require","ROUTER_INDEX_CONTENTS","ExpoMiddleware","constructor","options","projectRoot","resolveExtension","basePath","relativePath","resolvedPath","extension","path","extname","tsconfigPath","join","fs","existsSync","replace","parseRawBody","req","rawBody","Promise","resolve","reject","body","on","chunk","toString","err","JSON","parse","Error","type","makeOutputForInput","input","absolutePath","appDir","contents","handleRequestAsync","res","method","statusCode","end","properties","e","file","promises","mkdir","dirname","recursive","writeFile"],"mappings":"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"}