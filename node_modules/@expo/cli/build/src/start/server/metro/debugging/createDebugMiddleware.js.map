{"version":3,"sources":["../../../../../../src/start/server/metro/debugging/createDebugMiddleware.ts"],"sourcesContent":["import chalk from 'chalk';\nimport type { NextHandleFunction } from 'connect';\nimport { WebSocketServer } from 'ws';\n\nimport { createHandlersFactory } from './createHandlersFactory';\nimport { NETWORK_RESPONSE_STORAGE } from './messageHandlers/NetworkResponse';\nimport { Log } from '../../../../log';\nimport { env } from '../../../../utils/env';\nimport { isLocalSocket, isMatchingOrigin } from '../../../../utils/net';\n\nconst debug = require('debug')('expo:metro:debugging:middleware') as typeof console.log;\n\ninterface DebugMiddleware {\n  debugMiddleware: NextHandleFunction;\n  debugWebsocketEndpoints: Record<string, WebSocketServer>;\n}\n\ninterface DebugMiddlewareParams {\n  projectRoot: string;\n  serverBaseUrl: string;\n}\n\nexport function createDebugMiddleware({\n  projectRoot,\n  serverBaseUrl,\n}: DebugMiddlewareParams): DebugMiddleware {\n  // Load the React Native debugging tools from project\n  // TODO: check if this works with isolated modules\n  const { createDevMiddleware } =\n    require('@react-native/dev-middleware') as typeof import('@react-native/dev-middleware');\n\n  const { middleware, websocketEndpoints } = createDevMiddleware({\n    projectRoot,\n    serverBaseUrl,\n    logger: createLogger(chalk.bold('Debug:')),\n    unstable_customInspectorMessageHandler: createHandlersFactory(),\n    unstable_experiments: {\n      // Enable the Network tab in React Native DevTools\n      enableNetworkInspector: true,\n      // Only enable opening the browser version of React Native DevTools when debugging.\n      // This is useful when debugging the React Native DevTools by going to `/open-debugger` in the browser.\n      enableOpenDebuggerRedirect: env.EXPO_DEBUG,\n    },\n  });\n\n  const debuggerWebsocketEndpoint = websocketEndpoints['/inspector/debug'] as WebSocketServer;\n\n  // NOTE(cedric): add a temporary websocket to handle Network-related CDP events\n  websocketEndpoints['/inspector/network'] = createNetworkWebsocket(debuggerWebsocketEndpoint);\n\n  // Explicitly limit debugger websocket to loopback requests\n  debuggerWebsocketEndpoint.on('connection', (socket, request) => {\n    if (!isLocalSocket(request.socket) || !isMatchingOrigin(request, serverBaseUrl)) {\n      // NOTE: `socket.close` nicely closes the websocket, which will still allow incoming messages\n      // `socket.terminate` instead forcefully closes down the socket\n      socket.terminate();\n    }\n  });\n\n  return {\n    debugMiddleware(req, res, next) {\n      // The debugger middleware is skipped entirely if the connection isn't a loopback request\n      if (isLocalSocket(req.socket)) {\n        return middleware(req, res, next);\n      } else {\n        return next();\n      }\n    },\n    debugWebsocketEndpoints: websocketEndpoints,\n  };\n}\n\nfunction createLogger(\n  logPrefix: string\n): Parameters<typeof import('@react-native/dev-middleware').createDevMiddleware>[0]['logger'] {\n  return {\n    info: (...args) => Log.log(logPrefix, ...args),\n    warn: (...args) => Log.warn(logPrefix, ...args),\n    error: (...args) => Log.error(logPrefix, ...args),\n  };\n}\n\n/**\n * This adds a dedicated websocket connection that handles Network-related CDP events.\n * It's a temporary solution until Fusebox either implements the Network CDP domain,\n * or allows external domain agents that can send messages over the CDP socket to the debugger.\n * The Network websocket rebroadcasts events on the debugger CDP connections.\n */\nfunction createNetworkWebsocket(debuggerWebsocket: WebSocketServer) {\n  const wss = new WebSocketServer({\n    noServer: true,\n    perMessageDeflate: true,\n    // Don't crash on exceptionally large messages - assume the device is\n    // well-behaved and the debugger is prepared to handle large messages.\n    maxPayload: 0,\n  });\n\n  wss.on('connection', (networkSocket) => {\n    networkSocket.on('message', (data) => {\n      try {\n        // Parse the network message, to determine how the message should be handled\n        const message = JSON.parse(data.toString());\n\n        if (message.method === 'Expo(Network.receivedResponseBody)' && message.params) {\n          // If its a response body, write it to the global storage\n          const { requestId, ...requestInfo } = message.params;\n          NETWORK_RESPONSE_STORAGE.set(requestId, requestInfo);\n        } else if (message.method.startsWith('Network.')) {\n          // Otherwise, directly re-broadcast the Network events to all connected debuggers\n          debuggerWebsocket.clients.forEach((debuggerSocket) => {\n            if (debuggerSocket.readyState === debuggerSocket.OPEN) {\n              debuggerSocket.send(data.toString());\n            }\n          });\n        }\n      } catch (error) {\n        debug('Failed to handle Network CDP event', error);\n      }\n    });\n  });\n\n  return wss;\n}\n"],"names":["createDebugMiddleware","debug","require","projectRoot","serverBaseUrl","createDevMiddleware","middleware","websocketEndpoints","logger","createLogger","chalk","bold","unstable_customInspectorMessageHandler","createHandlersFactory","unstable_experiments","enableNetworkInspector","enableOpenDebuggerRedirect","env","EXPO_DEBUG","debuggerWebsocketEndpoint","createNetworkWebsocket","on","socket","request","isLocalSocket","isMatchingOrigin","terminate","debugMiddleware","req","res","next","debugWebsocketEndpoints","logPrefix","info","args","Log","log","warn","error","debuggerWebsocket","wss","WebSocketServer","noServer","perMessageDeflate","maxPayload","networkSocket","data","message","JSON","parse","toString","method","params","requestId","requestInfo","NETWORK_RESPONSE_STORAGE","set","startsWith","clients","forEach","debuggerSocket","readyState","OPEN","send"],"mappings":"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"}